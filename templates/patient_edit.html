{% extends "base.html" %}
{% block content %}
<a href="{{ url_for('patient_detail', patient_id=patient.id) }}">&larr; Volver</a>
<div class="card" style="margin-top:12px;">
    <h2>Editar paciente</h2>
    {% if error %}<div style="color:#c62828;">{{ error }}</div>{% endif %}
    <form method="post" enctype="multipart/form-data">
        <label>Nombre</label>
        <input type="text" name="name" value="{{ patient.name }}" required>
        <label>Foto (opcional)</label>
        <input type="file" name="photo" id="patient_photo_edit" accept="image/*">
        <div style="margin:8px 0; display:flex; align-items:center; gap:8px;">
            <div style="width:64px; height:64px; border-radius:50%; background:#e0e0e0; overflow:hidden;">
                {% if patient.photo_path %}
                <img id="patient_photo_preview_edit" src="{{ url_for('static', filename=patient.photo_path) }}" alt="avatar" style="width:100%; height:100%; object-fit:cover;">
                {% else %}
                <img id="patient_photo_preview_edit" src="" alt="" style="width:100%; height:100%; object-fit:cover; display:none;">
                {% endif %}
            </div>
        </div>
        <label>Fecha de nacimiento</label>
        <input type="date" name="date_of_birth" value="{{ patient.date_of_birth }}">
        <label>Diagnóstico</label>
        <input type="text" name="diagnosis" value="{{ patient.diagnosis }}">
        <label>Alergias</label>
        <input type="text" name="allergies" value="{{ patient.allergies }}">
        <label>Contacto de emergencia - Nombre</label>
        <input type="text" name="emergency_contact_name" value="{{ patient.emergency_contact_name }}">
        <label>Contacto de emergencia - Teléfono</label>
        <input type="text" name="emergency_contact_phone" value="{{ patient.emergency_contact_phone }}">
        <label>Contacto de emergencia - Relación</label>
        <input type="text" name="emergency_contact_relation" value="{{ patient.emergency_contact_relation }}">
        <label>Notas</label>
        <textarea name="notes" rows="3" placeholder="Notas (opcional)">{{ patient.notes }}</textarea>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
            <button type="submit">Guardar</button>
            <a href="{{ url_for('patient_detail', patient_id=patient.id) }}">
                <button type="button" style="background:#757575;">Cancelar</button>
            </a>
        </div>
    </form>
    {% if current_role == 'CARE_ADMIN' %}
    <div style="margin-top:16px;border-top:1px solid #eee;padding-top:12px;">
        <form method="post" action="{{ url_for('patient_delete', patient_id=patient.id) }}" onsubmit="return confirm('¿Eliminar paciente? Esta acción no se puede deshacer.');">
            <button type="submit" style="background:#c62828;">Eliminar paciente</button>
        </form>
    </div>
    {% endif %}
</div>
<script>
(function(){
    const input = document.getElementById("patient_photo_edit");
    const preview = document.getElementById("patient_photo_preview_edit");
    if (input) {
        input.addEventListener("change", (e)=>{
            const file = e.target.files && e.target.files[0];
            if (file) {
                const url = URL.createObjectURL(file);
                preview.src = url;
                preview.style.display = "block";
            }
        });
    }
})();
</script>
{% endblock %}
