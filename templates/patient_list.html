{% extends "base.html" %}
{% block content %}
<style>
  body { background:#f6f7fb; font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
  header { background:#fcfcfd !important; color:#2c2c2c !important; border-bottom:1px solid #e5e7eb; }
  header nav a { color:#2c2c2c !important; padding-bottom:4px; border-bottom:2px solid transparent; }
  header nav a:hover { border-bottom-color:#c5c7d0; }
  .page-shell { max-width:960px; margin:0 auto; padding:16px; }
  .top-bar { display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
  .title { margin:0; font-size:24px; font-weight:700; color:#1f2933; }
  .legend { display:flex; gap:8px; font-size:12px; color:#6b7280; flex-wrap:wrap; align-items:center; }
  .legend-badge { display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:12px; border:1px solid #e5e7eb; background:#fff; }
  .btn-primary { background:#2f6ff9; color:#fff; border:none; padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600; transition:all 0.15s ease; }
  .btn-primary:hover { background:#1f5ed8; }
  .patient-card-link { text-decoration:none; color:inherit; }
  .patient-card { cursor:pointer; padding:16px; min-height:120px; border-radius:16px; border:1px solid #e5e7eb; background:#fff; box-shadow:0 1px 4px rgba(0,0,0,0.06); transition:all 0.16s ease; }
  .patient-card:hover { box-shadow:0 4px 12px rgba(0,0,0,0.08); border-color:#d0d4dc; transform:translateY(-1px); }
  .patient-card-body { display:flex; gap:16px; align-items:center; }
  .patient-avatar { width:80px; height:80px; border-radius:50%; background:linear-gradient(135deg,#eceff3,#dfe3eb); overflow:hidden; flex-shrink:0; display:flex; align-items:center; justify-content:center; }
  .patient-avatar img { width:100%; height:100%; object-fit:cover; }
  .patient-info { flex:1; display:flex; flex-direction:column; gap:6px; }
  .patient-name { font-size:19px; font-weight:700; color:#1f2933; display:flex; align-items:center; gap:8px; }
  .patient-notes { font-size:13px; color:#6b7280; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .fall-badge { display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:12px; font-size:12px; font-weight:600; border:1px solid #e5e7eb; }
  .fall-0 { background:#f5f6f9; color:#4b5563; }
  .fall-1 { background:#fff3cd; color:#8a6d3b; }
  .fall-2 { background:#ffe4e0; color:#b42318; }
  .fall-3 { background:#e5e7eb; color:#111827; }
  .list-grid { display:flex; flex-direction:column; gap:12px; margin-top:12px; }
  @media (max-width:640px) {
    .patient-card-body { align-items:flex-start; }
    .patient-notes { white-space:normal; }
  }
</style>
<div class="row">
    <div class="col page-shell">
        <div class="top-bar">
            <div class="title">Pacientes</div>
            <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
                <div class="legend">
                    <span class="legend-badge fall-1">1 caída</span>
                    <span class="legend-badge fall-2">2 caídas</span>
                    <span class="legend-badge fall-3">3+ caídas</span>
                </div>
                <button id="open-patient-modal" type="button" class="btn-primary">+ Agregar paciente</button>
            </div>
        </div>
        {% if msg %}
        <div class="card" style="background:#e8f5e9;color:#2e7d32;">{{ msg }}</div>
        {% endif %}
        <div class="list-grid">
            {% for p in patients %}
            <a href="{{ url_for('patient_detail', patient_id=p.id) }}" class="patient-card-link">
                <div class="card patient-card">
                    <div class="patient-card-body">
                        <div class="patient-avatar">
                            {% if p.photo_path %}
                            <img src="{{ url_for('static', filename=p.photo_path) }}" alt="avatar">
                            {% endif %}
                        </div>
                        <div class="patient-info">
                            <div class="patient-name">
                                {{ p.name }}
                                {% set falls = fall_counts.get(p.id, 0) %}
                                {% if falls == 1 %}
                                    <span class="fall-badge fall-1" title="1 caída en los últimos 90 días">1 caída</span>
                                {% elif falls == 2 %}
                                    <span class="fall-badge fall-2" title="2 caídas en los últimos 90 días">2 caídas</span>
                                {% elif falls >= 3 %}
                                    <span class="fall-badge fall-3" title="3 o más caídas en los últimos 90 días">3+ caídas</span>
                                {% else %}
                                    <span class="fall-badge fall-0" title="Sin caídas recientes">0</span>
                                {% endif %}
                            </div>
                            {% if p.notes %}<div class="patient-notes">{{ p.notes }}</div>{% endif %}
                        </div>
                    </div>
                </div>
            </a>
            {% else %}
            <div class="card patient-card">No hay pacientes registrados.</div>
            {% endfor %}
        </div>
    </div>
</div>

<div id="patient-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.35); z-index:3000; align-items:center; justify-content:center;">
  <div style="background:white; padding:16px; border-radius:8px; width:95%; max-width:520px; max-height:90%; overflow:auto;">
    <h3>Agregar paciente</h3>
    <form method="post" action="{{ url_for('patient_new') }}" enctype="multipart/form-data">
        <label>Nombre</label>
        <input type="text" name="name" required>
        <label>Foto (opcional)</label>
        <input type="file" name="photo" id="patient_photo_input" accept="image/*">
        <div style="margin:8px 0; display:flex; align-items:center; gap:8px;">
            <div style="width:48px; height:48px; border-radius:50%; background:#e0e0e0; overflow:hidden;">
                <img id="patient_photo_preview" src="" alt="" style="width:100%; height:100%; object-fit:cover; display:none;">
            </div>
        </div>
        <label>Fecha de nacimiento</label>
        <input type="date" name="date_of_birth">
        <label>Diagnóstico</label>
        <input type="text" name="diagnosis">
        <label>Alergias</label>
        <input type="text" name="allergies">
        <label>Contacto de emergencia - Nombre</label>
        <input type="text" name="emergency_contact_name">
        <label>Contacto de emergencia - Teléfono</label>
        <input type="text" name="emergency_contact_phone">
        <label>Contacto de emergencia - Relación</label>
        <input type="text" name="emergency_contact_relation">
        <label>Notas</label>
        <textarea name="notes" rows="3" placeholder="Condiciones, contactos, etc. (opcional)"></textarea>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;">
            <button type="button" id="patient-cancel" style="background:#757575;">Cancelar</button>
            <button type="submit">Guardar</button>
        </div>
    </form>
  </div>
</div>
<script>
(function() {
    const modal = document.getElementById("patient-modal");
    const openBtn = document.getElementById("open-patient-modal");
    const cancelBtn = document.getElementById("patient-cancel");
    if (openBtn && modal) {
        openBtn.addEventListener("click", ()=> { modal.style.display="flex"; });
    }
    if (cancelBtn && modal) {
        cancelBtn.addEventListener("click", ()=> { modal.style.display="none"; });
    }
    document.addEventListener("click", (e)=>{
        if (e.target === modal) modal.style.display="none";
    });
    const photoInput = document.getElementById("patient_photo_input");
    const photoPreview = document.getElementById("patient_photo_preview");
    if (photoInput) {
        photoInput.addEventListener("change", (e)=>{
            const file = e.target.files && e.target.files[0];
            if (file) {
                const url = URL.createObjectURL(file);
                photoPreview.src = url;
                photoPreview.style.display = "block";
            } else {
                photoPreview.src = "";
                photoPreview.style.display = "none";
            }
        });
    }
})();
</script>
<style>
.patient-card-link { text-decoration: none; color: inherit; }
.patient-card { cursor: pointer; padding: 14px; min-height: 100px; transition: box-shadow 0.15s ease, transform 0.1s ease; }
.patient-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.12); }
.patient-card-body { display: flex; gap: 14px; align-items: center; padding-top: 4px; padding-bottom: 4px; }
.patient-avatar { width: 72px; height: 72px; border-radius: 50%; background: #e0e0e0; overflow: hidden; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
.patient-avatar img { width: 100%; height: 100%; object-fit: cover; }
.patient-info { flex: 1; display: flex; flex-direction: column; gap: 4px; }
.patient-name { font-size: 18px; font-weight: 700; }
.patient-notes { font-size: 13px; }
.status-dot { display:inline-block; width:14px; height:14px; border-radius:50%; box-shadow: 0 0 0 1px rgba(0,0,0,0.08), 0 1px 3px rgba(0,0,0,0.15); }
.dot-yellow { background:#fdd835; }
.dot-red { background:#d32f2f; }
.dot-gray { background:#424242; }
</style>
{% endblock %}
