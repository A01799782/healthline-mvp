{% extends "base.html" %}
{% block content %}
<div class="row">
    <div class="col">
        <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;">
            <h2 style="margin:0;">Pacientes</h2>
            <button id="open-patient-modal" type="button">+ Agregar paciente</button>
        </div>
        {% if msg %}
        <div class="card" style="background:#e8f5e9;color:#2e7d32;">{{ msg }}</div>
        {% endif %}
        {% for p in patients %}
        <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <div>
                        <strong>{{ p.name }}</strong>
                        {% set falls = fall_counts.get(p.id, 0) %}
                        {% if falls == 1 %} üü°{% elif falls == 2 %} üî¥{% elif falls >=3 %} ‚ö´{% endif %}
                    </div>
                    {% if p.notes %}<div class="muted">{{ p.notes }}</div>{% endif %}
                    <div style="margin-top:8px;">
                        <a href="{{ url_for('patient_detail', patient_id=p.id) }}">Ver detalle</a>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="card">No hay pacientes registrados.</div>
        {% endfor %}
    </div>
</div>

<div id="patient-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.35); z-index:3000; align-items:center; justify-content:center;">
  <div style="background:white; padding:16px; border-radius:8px; width:95%; max-width:520px; max-height:90%; overflow:auto;">
    <h3>Agregar paciente</h3>
    <form method="post" action="{{ url_for('patient_new') }}">
        <label>Nombre</label>
        <input type="text" name="name" required>
        <label>Fecha de nacimiento</label>
        <input type="date" name="date_of_birth">
        <label>Diagn√≥stico</label>
        <input type="text" name="diagnosis">
        <label>Alergias</label>
        <input type="text" name="allergies">
        <label>Contacto de emergencia - Nombre</label>
        <input type="text" name="emergency_contact_name">
        <label>Contacto de emergencia - Tel√©fono</label>
        <input type="text" name="emergency_contact_phone">
        <label>Contacto de emergencia - Relaci√≥n</label>
        <input type="text" name="emergency_contact_relation">
        <label>Notas</label>
        <textarea name="notes" rows="3" placeholder="Condiciones, contactos, etc. (opcional)"></textarea>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;">
            <button type="button" id="patient-cancel" style="background:#757575;">Cancelar</button>
            <button type="submit">Guardar</button>
        </div>
    </form>
  </div>
</div>
<script>
(function() {
    const modal = document.getElementById("patient-modal");
    const openBtn = document.getElementById("open-patient-modal");
    const cancelBtn = document.getElementById("patient-cancel");
    if (openBtn && modal) {
        openBtn.addEventListener("click", ()=> { modal.style.display="flex"; });
    }
    if (cancelBtn && modal) {
        cancelBtn.addEventListener("click", ()=> { modal.style.display="none"; });
    }
    document.addEventListener("click", (e)=>{
        if (e.target === modal) modal.style.display="none";
    });
})();
</script>
{% endblock %}
