{% extends "base.html" %}
{% block content %}
<div class="row">
    <div class="col">
        <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;">
            <h2 style="margin:0;">Pacientes</h2>
            <button id="open-patient-modal" type="button">+ Agregar paciente</button>
        </div>
        {% if msg %}
        <div class="card" style="background:#e8f5e9;color:#2e7d32;">{{ msg }}</div>
        {% endif %}
        {% for p in patients %}
        <a href="{{ url_for('patient_detail', patient_id=p.id) }}" class="patient-card-link">
            <div class="card patient-card">
                <div class="patient-card-body">
                    <div class="patient-avatar">
                        {% if p.photo_path %}
                        <img src="{{ url_for('static', filename=p.photo_path) }}" alt="avatar">
                        {% endif %}
                    </div>
                    <div class="patient-info">
                        <div style="display:flex;align-items:center;gap:6px;">
                            <div class="patient-name">{{ p.name }}</div>
                            {% set falls = fall_counts.get(p.id, 0) %}
                            {% if falls == 1 %} üü°{% elif falls == 2 %} üî¥{% elif falls >=3 %} ‚ö´{% endif %}
                        </div>
                        {% if p.notes %}<div class="muted patient-notes">{{ p.notes }}</div>{% endif %}
                    </div>
                </div>
            </div>
        </a>
        {% else %}
        <div class="card">No hay pacientes registrados.</div>
        {% endfor %}
    </div>
</div>

<div id="patient-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.35); z-index:3000; align-items:center; justify-content:center;">
  <div style="background:white; padding:16px; border-radius:8px; width:95%; max-width:520px; max-height:90%; overflow:auto;">
    <h3>Agregar paciente</h3>
    <form method="post" action="{{ url_for('patient_new') }}" enctype="multipart/form-data">
        <label>Nombre</label>
        <input type="text" name="name" required>
        <label>Foto (opcional)</label>
        <input type="file" name="photo" id="patient_photo_input" accept="image/*">
        <div style="margin:8px 0; display:flex; align-items:center; gap:8px;">
            <div style="width:48px; height:48px; border-radius:50%; background:#e0e0e0; overflow:hidden;">
                <img id="patient_photo_preview" src="" alt="" style="width:100%; height:100%; object-fit:cover; display:none;">
            </div>
        </div>
        <label>Fecha de nacimiento</label>
        <input type="date" name="date_of_birth">
        <label>Diagn√≥stico</label>
        <input type="text" name="diagnosis">
        <label>Alergias</label>
        <input type="text" name="allergies">
        <label>Contacto de emergencia - Nombre</label>
        <input type="text" name="emergency_contact_name">
        <label>Contacto de emergencia - Tel√©fono</label>
        <input type="text" name="emergency_contact_phone">
        <label>Contacto de emergencia - Relaci√≥n</label>
        <input type="text" name="emergency_contact_relation">
        <label>Notas</label>
        <textarea name="notes" rows="3" placeholder="Condiciones, contactos, etc. (opcional)"></textarea>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;">
            <button type="button" id="patient-cancel" style="background:#757575;">Cancelar</button>
            <button type="submit">Guardar</button>
        </div>
    </form>
  </div>
</div>
<script>
(function() {
    const modal = document.getElementById("patient-modal");
    const openBtn = document.getElementById("open-patient-modal");
    const cancelBtn = document.getElementById("patient-cancel");
    if (openBtn && modal) {
        openBtn.addEventListener("click", ()=> { modal.style.display="flex"; });
    }
    if (cancelBtn && modal) {
        cancelBtn.addEventListener("click", ()=> { modal.style.display="none"; });
    }
    document.addEventListener("click", (e)=>{
        if (e.target === modal) modal.style.display="none";
    });
    const photoInput = document.getElementById("patient_photo_input");
    const photoPreview = document.getElementById("patient_photo_preview");
    if (photoInput) {
        photoInput.addEventListener("change", (e)=>{
            const file = e.target.files && e.target.files[0];
            if (file) {
                const url = URL.createObjectURL(file);
                photoPreview.src = url;
                photoPreview.style.display = "block";
            } else {
                photoPreview.src = "";
                photoPreview.style.display = "none";
            }
        });
    }
})();
</script>
<style>
.patient-card-link { text-decoration: none; color: inherit; }
.patient-card { cursor: pointer; padding: 14px; min-height: 100px; transition: box-shadow 0.15s ease, transform 0.1s ease; }
.patient-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.12); }
.patient-card-body { display: flex; gap: 14px; align-items: center; padding-top: 4px; padding-bottom: 4px; }
.patient-avatar { width: 72px; height: 72px; border-radius: 50%; background: #e0e0e0; overflow: hidden; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
.patient-avatar img { width: 100%; height: 100%; object-fit: cover; }
.patient-info { flex: 1; display: flex; flex-direction: column; gap: 4px; }
.patient-name { font-size: 18px; font-weight: 700; }
.patient-notes { font-size: 13px; }
</style>
{% endblock %}
