{% extends "base.html" %}
{% block content %}
<style>
  .adherence-grid {
    display: inline-grid;
    grid-template-columns: auto auto;
    row-gap: 4px;
    column-gap: 12px;
  }
  .adherence-pct { margin-top: 8px; font-weight: 600; }
  .adherence-grid div:nth-child(2n) {
    text-align: right;
    font-weight: 600;
    justify-self: end;
  }
  .adherence-pct-row{
    display:flex;
    gap:8px;
    margin-top:8px;
  }
</style>

<a href="{{ url_for('patient_list') }}">&larr; Volver</a>
<div style="display:flex;align-items:center;gap:12px;">
    <h2 style="margin:0;">{{ patient.name }}</h2>
    <a href="{{ url_for('patient_edit', patient_id=patient.id) }}" style="text-decoration:none;">
        <button type="button">Editar</button>
    </a>
    <a href="{{ url_for('patient_today', patient_id=patient.id) }}" style="text-decoration:none;">
        <button type="button" style="background:#0d47a1;">Agenda de hoy</button>
    </a>
</div>
{% if patient.notes %}<div class="muted">{{ patient.notes }}</div>{% endif %}
{% if msg %}
<div class="card" style="background:#e8f5e9;color:#2e7d32;margin-top:8px;">{{ msg }}</div>
{% endif %}

<div class="card" style="margin-top:12px;">
    <h3>Perfil del paciente</h3>
    <table>
        <tr><th>Edad</th><td>{% if age is not none %}{{ age }} años{% else %}—{% endif %}</td></tr>
        <tr><th>Fecha de nacimiento</th><td>{{ patient.date_of_birth or "—" }}</td></tr>
        <tr><th>Diagnóstico</th><td>{{ patient.diagnosis or "—" }}</td></tr>
        <tr><th>Alergias</th><td>{{ patient.allergies or "—" }}</td></tr>
        <tr><th>Contacto de emergencia</th><td>{{ patient.emergency_contact_name or "—" }}</td></tr>
        <tr><th>Teléfono emergencia</th><td>{{ patient.emergency_contact_phone or "—" }}</td></tr>
        <tr><th>Relación</th><td>{{ patient.emergency_contact_relation or "—" }}</td></tr>
    </table>
</div>

<div class="card" style="margin-top:12px;">
    <h3>Eventualidades</h3>
    <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
        <div>Caídas últimos 90 días: <strong>{{ fall_count }}</strong></div>
        <a href="{{ url_for('fall_new', patient_id=patient.id) }}"><button type="button">Reportar caída</button></a>
        <a href="{{ url_for('falls_list', patient_id=patient.id) }}">Ver historial de caídas</a>
    </div>
</div>
<!-- DO NOT EDIT: Adherencia copy/rows are final. No agregar "(vencidas)" ni filas "Futuras" en 7d/30d. -->
<div class="card">
    <h3>Adherencia</h3>
    <div style="display:flex;gap:16px;flex-wrap:wrap;">
        <div style="flex:1;min-width:220px;">
            <div style="font-weight:bold;margin-bottom:8px;">Hoy</div>
            <div class="adherence-grid">
                <div>Tomadas</div><div>{{ adherence_today.taken_due }}</div>
                <div>Omitidas</div><div>{{ adherence_today.skipped_due }}</div>
                <div>Vencidas</div><div>{{ adherence_today.overdue_due }}</div>
                <div>Futuras</div><div>{{ adherence_today.pending_future }}</div>
            </div>
        </div>
        <div style="flex:1;min-width:220px;">
            <div style="font-weight:bold;margin-bottom:8px;">Últimos 7 días</div>
            <div class="adherence-grid">
                <div>Tomadas</div><div>{{ adherence_7d.taken_due }}</div>
                <div>Omitidas</div><div>{{ adherence_7d.skipped_due }}</div>
                <div>Vencidas</div><div>{{ adherence_7d.overdue_due }}</div>
            </div>
            <div class="adherence-pct-row">
              <span>% Adherencia</span>
              <strong>{% if adherence_pct_7d is not none %}{{ adherence_pct_7d }}%{% else %}—{% endif %}</strong>
            </div>
        </div>
        <div style="flex:1;min-width:220px;">
            <div style="font-weight:bold;margin-bottom:8px;">Últimos 30 días</div>
            <div class="adherence-grid">
                <div>Tomadas</div><div>{{ adherence_30d.taken_due }}</div>
                <div>Omitidas</div><div>{{ adherence_30d.skipped_due }}</div>
                <div>Vencidas</div><div>{{ adherence_30d.overdue_due }}</div>
            </div>
            <div class="adherence-pct-row">
              <span>% Adherencia</span>
              <strong>{% if adherence_pct_30d is not none %}{{ adherence_pct_30d }}%{% else %}—{% endif %}</strong>
            </div>
        </div>
    </div>
</div>

<div class="row" style="margin-top:12px;">
    <div class="col">
        <h3>Medicamentos</h3>
        {% for med, events in meds_with_events %}
        <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <div><strong>{{ med.name }}</strong> <span class="pill">{{ (med.dose_value and med.dose_unit) and (med.dose_value ~ ' ' ~ med.dose_unit) or med.dose }}</span></div>
                <div style="display:flex;gap:8px;align-items:center;">
                    <form method="post" action="{{ url_for('medication_toggle_active', med_id=med.id) }}">
                        {% if med.active %}
                        <button type="submit" style="background:#f9a825;">Pausar</button>
                        {% else %}
                        <button type="submit" style="background:#2e7d32;">Reanudar</button>
                        {% endif %}
                    </form>
                    <a href="{{ url_for('medication_edit', med_id=med.id) }}">
                        <button type="button">Editar</button>
                    </a>
                    {% if med.ended %}
                        <span class="pill" style="background:#fce4ec;color:#c2185b;">Terminado</span>
                    {% elif not med.active %}
                        <span class="pill" style="background:#fff3e0;color:#ef6c00;">Pausado</span>
                    {% else %}
                        <span class="pill" style="background:#e8f5e9;color:#2e7d32;">Activo</span>
                    {% endif %}
                </div>
            </div>
            <div class="muted">
                Cada {{ med.frequency_hours }} horas{% if med.notes %} · {{ med.notes }}{% endif %}
                {% if med.start_time %} · Inicio: {{ fmt_dt(med.start_time) }}{% endif %}
                {% if med.end_time %} · Fin: {{ fmt_dt(med.end_time) }}{% endif %}
            </div>
            <div style="margin-top:8px;">
                <strong>Próximas tomas</strong>
                <table>
                    <tr><th>Horario</th><th>Estado</th><th>Acción</th></tr>
                    {% for ev in events %}
                    <tr>
                        <td>{{ fmt_dt(ev.scheduled_time) }}</td>
                        <td>{% if ev.taken %}Realizada{% else %}Pendiente{% endif %}</td>
                        <td>
                            {% if not ev.taken %}
                            <form method="post" action="{{ url_for('take_dose', event_id=ev.id) }}">
                                <button type="submit">Marcar</button>
                            </form>
                            {% else %}
                            —
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="3" class="muted">Sin registros aún.</td></tr>
                    {% endfor %}
                </table>
            </div>
        </div>
        {% else %}
        <div class="card">Aún no hay medicamentos.</div>
        {% endfor %}
    </div>
</div>
<div class="card">
    <div style="display:flex;align-items:center;justify-content:space-between;">
      <h3 style="margin:0;">Agregar medicamento</h3>
      <button id="open-med-wizard" type="button">+ Agregar medicamento</button>
    </div>
</div>

<div id="med-wizard" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.35); z-index:3000; align-items:center; justify-content:center;">
  <div style="background:white; padding:18px; border-radius:10px; width:95%; max-width:560px; max-height:90%; overflow:auto;">
    <form id="med-wizard-form" method="post" action="{{ url_for('medication_new') }}">
      <input type="hidden" name="patient_id" value="{{ patient.id }}">
      <input type="hidden" name="rxnorm_rxcui" id="rxnorm_rxcui_new">
      <input type="hidden" name="rxnorm_name" id="rxnorm_name_new">
      <input type="hidden" name="name" id="wizard_name" required>
      <input type="hidden" name="dose" id="wizard_dose_display" required>
      <input type="hidden" name="dose_value" id="wizard_dose_value" required>
      <input type="hidden" name="dose_unit" id="wizard_dose_unit" required>
      <input type="hidden" name="frequency_hours" id="wizard_freq" required>
      <input type="hidden" name="start_time" id="wizard_start">
      <input type="hidden" name="end_time" id="wizard_end">
      <input type="hidden" name="notes" id="wizard_notes">

      <div id="wizard-step-1" class="wizard-step">
        <h3 style="margin-top:0;">¿Qué medicamento?</h3>
        <label>Nombre</label>
        <input type="text" id="med_name_new" placeholder="Ej. Ibuprofeno" required>
        <div style="margin-top:12px;">
          <button type="button" id="wizard-next-1">Siguiente</button>
        </div>
      </div>

      <div id="wizard-step-2" class="wizard-step" style="display:none;">
        <h3 style="margin-top:0;">¿En qué presentación y cuánto?</h3>
        <label>Unidad</label>
        <select id="wizard_unit">
          {% set units = ["tableta","cápsula","mg","g","ml","gotas","inhalaciones","otro"] %}
          {% for u in units %}
          <option value="{{ u }}">{{ u }}</option>
          {% endfor %}
        </select>
        <label style="margin-top:8px;">Cantidad por toma</label>
        <input type="text" id="wizard_amount" placeholder="Ej. 1">
        <div id="wizard_amount_presets" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;"></div>
        <div style="margin-top:12px;display:flex;gap:8px;">
          <button type="button" id="wizard-back-2">Atrás</button>
          <button type="button" id="wizard-next-2">Siguiente</button>
        </div>
      </div>

      <div id="wizard-step-3" class="wizard-step" style="display:none;">
        <h3 style="margin-top:0;">¿Cada cuánto y a qué hora empieza?</h3>
        <div id="freq-presets" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;">
          <button type="button" class="freq-btn" data-hours="24">1 vez al día</button>
          <button type="button" class="freq-btn" data-hours="12">2 veces al día</button>
          <button type="button" class="freq-btn" data-hours="8">3 veces al día</button>
          <button type="button" class="freq-btn" data-hours="6">4 veces al día</button>
          <button type="button" class="freq-btn" data-hours="6">Cada 6 horas</button>
          <button type="button" class="freq-btn" data-hours="8">Cada 8 horas</button>
          <button type="button" class="freq-btn" data-hours="12">Cada 12 horas</button>
          <button type="button" class="freq-btn" data-hours="custom">Otro</button>
        </div>
        <div id="wizard_freq_custom" style="display:none;margin-top:4px;">
          <input type="number" id="wizard_freq_input" min="1" placeholder="Horas">
        </div>
        <label style="margin-top:8px;">Hora inicial</label>
        <input type="datetime-local" id="wizard_start_input">
        <div style="margin-top:12px;display:flex;gap:8px;">
          <button type="button" id="wizard-back-3">Atrás</button>
          <button type="button" id="wizard-next-3">Siguiente</button>
        </div>
      </div>

      <div id="wizard-step-4" class="wizard-step" style="display:none;">
        <h3 style="margin-top:0;">¿Algo más?</h3>
        <label>Duración (fin del tratamiento)</label>
        <input type="datetime-local" id="wizard_end_input">
        <label>Instrucciones</label>
        <textarea id="wizard_notes_input" rows="3" placeholder="Notas adicionales"></textarea>
        <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;">
          <button type="button" id="wizard-back-4">Atrás</button>
          <button type="submit">Guardar</button>
        </div>
      </div>
    </form>
    <div style="margin-top:8px;">
      <button type="button" id="wizard-cancel" style="background:#c62828;">Cancelar</button>
    </div>
  </div>
</div>
<script>
(function() {
    const wizard = document.getElementById("med-wizard");
    const openBtn = document.getElementById("open-med-wizard");
    const cancelBtn = document.getElementById("wizard-cancel");
    const steps = ["wizard-step-1","wizard-step-2","wizard-step-3","wizard-step-4"].map(id => document.getElementById(id));
    const showStep = (idx) => steps.forEach((s,i)=> s.style.display = i===idx ? "block":"none");
    const setDefaultStart = () => {
        const now = new Date();
        const iso = new Date(now.getTime() - now.getTimezoneOffset()*60000).toISOString().slice(0,16);
        const input = document.getElementById("wizard_start_input");
        if (input && !input.value) input.value = iso;
        wizardStart.value = input ? input.value : iso;
    };
    openBtn.addEventListener("click", ()=> { wizard.style.display="flex"; setDefaultStart(); showStep(0); });
    cancelBtn.addEventListener("click", ()=> { wizard.style.display="none"; });

    const nameInput = document.getElementById("med_name_new");
    const rxId = document.getElementById("rxnorm_rxcui_new");
    const rxName = document.getElementById("rxnorm_name_new");
    const wizardName = document.getElementById("wizard_name");
    const wizardDoseDisplay = document.getElementById("wizard_dose_display");
    const wizardDoseValue = document.getElementById("wizard_dose_value");
    const wizardDoseUnit = document.getElementById("wizard_dose_unit");
    const wizardFreq = document.getElementById("wizard_freq");
    const wizardStart = document.getElementById("wizard_start");
    const wizardEnd = document.getElementById("wizard_end");
    const wizardNotes = document.getElementById("wizard_notes");

    const next1 = document.getElementById("wizard-next-1");
    next1.addEventListener("click", ()=> {
        if (!nameInput.value.trim()) return alert("Ingresa un nombre");
        wizardName.value = nameInput.value.trim();
        showStep(1);
    });

    const unitSelect = document.getElementById("wizard_unit");
    const amountInput = document.getElementById("wizard_amount");
    const presetsDiv = document.getElementById("wizard_amount_presets");
    const presetMap = {
        "tableta": ["1", "2", "0.5"],
        "cápsula": ["1", "2"],
        "ml": ["5", "10", "15", "20"],
        "mg": ["100", "200", "500"],
        "g": ["0.5", "1", "2"],
        "gotas": ["5", "10", "15"],
        "inhalaciones": ["1", "2"],
        "otro": []
    };
    const renderPresets = () => {
        const key = unitSelect.value;
        const opts = presetMap[key] || [];
        presetsDiv.innerHTML = "";
        opts.forEach(v=>{
            const b=document.createElement("button");
            b.type="button";
            b.textContent=v;
            b.addEventListener("click", ()=> amountInput.value = v);
            presetsDiv.appendChild(b);
        });
    };
    unitSelect.addEventListener("change", renderPresets);
    renderPresets();

    document.getElementById("wizard-back-2").addEventListener("click", ()=> showStep(0));
    document.getElementById("wizard-next-2").addEventListener("click", ()=> {
        if (!amountInput.value.trim()) return alert("Ingresa cantidad por toma");
        wizardDoseValue.value = amountInput.value.trim();
        wizardDoseUnit.value = unitSelect.value;
        wizardDoseDisplay.value = unitSelect.value === "otro" ? amountInput.value.trim() : `${amountInput.value.trim()} ${unitSelect.value}`;
        showStep(2);
    });

    const freqButtons = document.querySelectorAll(".freq-btn");
    const freqCustom = document.getElementById("wizard_freq_custom");
    const freqInput = document.getElementById("wizard_freq_input");
    let selectedFreq = null;
    selectedFreq = (freqButtons[0] && freqButtons[0].dataset.hours) || null;
    if (freqButtons[0]) freqButtons[0].style.background = "#e3f2fd";
    freqButtons.forEach(btn=>{
        btn.addEventListener("click", ()=>{
            freqButtons.forEach(b=> b.style.background="");
            btn.style.background="#e3f2fd";
            selectedFreq = btn.dataset.hours;
            freqCustom.style.display = selectedFreq === "custom" ? "block" : "none";
        });
    });
    document.getElementById("wizard-back-3").addEventListener("click", ()=> showStep(1));
    document.getElementById("wizard-next-3").addEventListener("click", ()=> {
        let hours;
        if (selectedFreq === "custom") {
            hours = parseInt(freqInput.value,10);
            if (!hours || hours <= 0) return alert("Ingresa horas válidas");
        } else {
            hours = parseInt(selectedFreq || "0",10);
        }
        wizardFreq.value = hours;
        const startVal = document.getElementById("wizard_start_input").value;
        if (startVal) {
            wizardStart.value = startVal;
        }
        showStep(3);
    });

    document.getElementById("wizard-back-4").addEventListener("click", ()=> showStep(2));
    document.getElementById("wizard_end_input").addEventListener("change", (e)=> wizardEnd.value = e.target.value);
    document.getElementById("wizard_notes_input").addEventListener("input", (e)=> wizardNotes.value = e.target.value);

    const initRx = function() { window.setupRxnorm("med_name_new", "rxnorm_rxcui_new", "rxnorm_name_new"); };
    if (window.setupRxnorm) { initRx(); }
    else { window.addEventListener("load", function() { if (window.setupRxnorm) initRx(); }); }
})();
</script>
{% endblock %}
